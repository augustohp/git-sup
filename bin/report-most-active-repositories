#!/usr/bin/env sh
# vim: ft=sh noet ts=4 sw=4:

APP_NAME=$(basename $0)
APP_VERSION="1.0.0"
OPTION_SINCE_WHEN_TO_COUNT="6 month ago"
OPTION_DIRECTORY=$(pwd)

test ! -z "$DEBUG" && { set -x; }

command_help()
{
	cat <<-EOT
	Usage: $APP_NAME
	       $APP_NAME [-v | --version ]
	       $APP_NAME [-h | --help ]
	       $APP_NAME [-s <date> | --pattern <date>]
		   $APP_NAME [-d <path> | --directory <path>]
	
	Will display the path of Git repositories found in *directory* ordered
	by their number of commits, the ones with most first.

	Options:
	  -s <date>  Since when to start counting commits?
				 Default: ${OPTION_SINCE_WHEN_TO_COUNT}
	  -d <path>  Where to find Git repositories?
	             Default: ${OPTION_DIRECTORY}
	
	Send bugs or suggestions to augusto.hp@gmail.com
	EOT
}

main()
{
	for_every_dir_containing \
		--pattern ".git" \
		--command "git log --oneline --since '${OPTION_SINCE_WHEN_TO_COUNT}' | wc -l" \
		--directory "${OPTION_DIRECTORY}" \
		| sort -nr
}

while :;
do
	if [ $# = 0 ]
	then
		break
	fi

	case $1 in
		-h|--help)
			command_help
			exit 0
			;;
		-v|--version)
			echo "$APP_NAME $APP_VERSION"
			exit 0
			;;
		-s|--since)
			OPTION_SINCE_WHEN_TO_COUNT="$2"
			shift
			;;
		-d|--directory)
			OPTION_DIRECTORY="$2"
			shift
			;;
		--)
			break
			;;
	esac
	shift
done

main $@
