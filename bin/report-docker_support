#!/usr/bin/env bash
#vim: ft=sh noet:

APP_NAME=$(basename $0)
APP_VERSION="1.0.0"
OPTION_HOWLONG="6 month ago"

command_help()
{
	cat <<-EOT
	Usage: $APP_NAME
	       $APP_NAME [-v | --version]
	       $APP_NAME [-h | --help]
	       $APP_NAME [-s <d> | --since <d>]
	
	Will print the percentage of commits that are not merge commits.

	Options
	  -s <d>     Considers repository to be inactive if there are no commits
	             since that period (Default: $OPTION_HOWLONG).

	Send bugs or suggestions to augusto.hp@gmail.com
	EOT
}

test ! -z "$DEBUG" && { set -x; }

while :;
do
	if [ $# = 0 ]
	then
		break
	fi

	case $1 in
		-h|--help)
			command_help
			exit 0
			;;
		-s|--since)
			OPTION_HOWLONG="$2"
			shift
			;;
		-v|--version)
			echo "$APP_NAME $APP_VERSION"
			exit 0
			;;
		--)
			break
			;;
	esac
	shift
done

for repository in $(report-commit_count | sort -nr | cut -f2 | head -n 30)
do 
    pushd "$repository" > /dev/null
	presence_dockerfile=No
	presence_compose=No
	presence_dev=No
	if [ 0 -lt $(find . -name Dockerfile -type f | wc -l) ]
	then
		presence_dockerfile=Yes
	fi
	if [ 0 -lt $(find . -name docker-compose.yml -type f | wc -l) ]
	then
		presence_compose=Yes
	fi
	if [ 0 -lt $(find . -name .docker-dev -type d | wc -l) ]
	then
		presence_dev=Yes
	fi
    echo "| $repository | $presence_dockerfile | $presence_compose | $presence_dev |"
	popd > /dev/null
done
